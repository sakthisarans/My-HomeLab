# ansible-playbook generate_sa_kubeconfig.yml -e "sa_name=myuser namespace=dev role=contributor"

---
- name: Generate kubeconfig for ServiceAccount in MicroK8s
  hosts: k8s-master
  gather_facts: false
  vars:
    sa_name: "{{ sa_name | default('sakthi') }}"
    kube_namespace: "{{ kube_namespace | default('default') }}"
    role: "{{ role | default('viewer') }}"
    secret_name: "{{ sa_name }}-token"
    kubeconfig_file: "{{ sa_name }}.kubeconfig"

  tasks:

    # ---------------- Namespace ----------------
    - name: Check if namespace exists
      ansible.builtin.command: microk8s kubectl get namespace {{ kube_namespace }}
      register: ns_check
      failed_when: false
      changed_when: false

    - name: Create namespace if missing
      ansible.builtin.command: microk8s kubectl create namespace {{ kube_namespace }}
      when: ns_check.rc != 0
      register: ns_create
      failed_when: false
      changed_when: "'created' in ns_create.stdout"

    # ---------------- ServiceAccount ----------------
    - name: Check if ServiceAccount exists
      ansible.builtin.command: microk8s kubectl get sa {{ sa_name }} -n {{ kube_namespace }}
      register: sa_check
      failed_when: false
      changed_when: false

    - name: Create ServiceAccount if missing
      ansible.builtin.command: microk8s kubectl create serviceaccount {{ sa_name }} -n {{ kube_namespace }}
      when: sa_check.rc != 0
      register: sa_create
      failed_when: false
      changed_when: "'created' in sa_create.stdout"

    # ---------------- Token Secret ----------------
    - name: Create ServiceAccount token Secret YAML (temp)
      ansible.builtin.copy:
        dest: /tmp/{{ secret_name }}.yaml
        content: |
          apiVersion: v1
          kind: Secret
          metadata:
            name: {{ secret_name }}
            namespace: {{ kube_namespace }}
            annotations:
              kubernetes.io/service-account.name: {{ sa_name }}
          type: kubernetes.io/service-account-token
        mode: '0600'
      when: sa_check.rc != 0

    - name: Apply token secret
      ansible.builtin.command: microk8s kubectl apply -f /tmp/{{ secret_name }}.yaml
      changed_when: false
      when: sa_check.rc != 0

    - name: Wait for token population
      ansible.builtin.wait_for:
        timeout: 10
        path: /tmp/{{ secret_name }}.yaml
      when: sa_check.rc != 0

    # ---------------- Get token and CA ----------------
    - name: Get ServiceAccount token
      ansible.builtin.command: >
        microk8s kubectl get secret {{ secret_name }} -n {{ kube_namespace }}
        -o jsonpath='{.data.token}'
      register: token_b64
      changed_when: false
      failed_when: false

    - name: Decode token
      ansible.builtin.set_fact:
        token: "{{ token_b64.stdout | b64decode }}"

    - name: Get CA certificate
      ansible.builtin.command: >
        microk8s kubectl get secret {{ secret_name }} -n {{ kube_namespace }}
        -o jsonpath='{.data["ca\\.crt"]}'
      register: ca_b64
      changed_when: false
      failed_when: false

    # ---------------- Cluster info ----------------
    - name: Get cluster name
      ansible.builtin.command: microk8s kubectl config view --minify -o jsonpath='{.clusters[0].name}'
      register: cluster_name
      changed_when: false

    - name: Get cluster server
      ansible.builtin.command: microk8s kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}'
      register: cluster_server
      changed_when: false

    # ---------------- Role / RoleBinding ----------------
    - name: Check existing bindings
      block:
        - name: Check admin ClusterRoleBinding
          ansible.builtin.command: microk8s kubectl get clusterrolebinding {{ sa_name }}-admin-binding
          register: rb_check_admin
          failed_when: false
          changed_when: false

        - name: Check contributor RoleBinding
          ansible.builtin.command: microk8s kubectl get rolebinding {{ sa_name }}-contributor-binding -n {{ kube_namespace }}
          register: rb_check_contributor
          failed_when: false
          changed_when: false

        - name: Check viewer RoleBinding
          ansible.builtin.command: microk8s kubectl get rolebinding {{ sa_name }}-viewer-binding -n {{ kube_namespace }}
          register: rb_check_viewer
          failed_when: false
          changed_when: false

    - name: Create ClusterRoleBinding for admin
      ansible.builtin.command: >
        microk8s kubectl create clusterrolebinding {{ sa_name }}-admin-binding
        --clusterrole=cluster-admin
        --serviceaccount={{ kube_namespace }}:{{ sa_name }}
      when:
        - role == 'admin'
        - rb_check_admin.rc != 0
      register: crb_create
      failed_when: false
      changed_when: "'created' in crb_create.stdout"

    - name: Create contributor Role YAML
      ansible.builtin.copy:
        dest: /tmp/{{ sa_name }}-contributor-role.yaml
        content: |
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            namespace: {{ kube_namespace }}
            name: {{ sa_name }}-contributor-role
          rules:
            - apiGroups: [""]
              resources: ["pods","services","deployments"]
              verbs: ["get","list","create","update","patch"]
            - apiGroups: [""]
              resources: ["secrets"]
              verbs: []
        mode: '0600'
      when:
        - role == 'contributor'
        - rb_check_contributor.rc != 0

    - name: Apply contributor Role
      ansible.builtin.command: microk8s kubectl apply -f /tmp/{{ sa_name }}-contributor-role.yaml
      when:
        - role == 'contributor'
        - rb_check_contributor.rc != 0
      changed_when: false

    - name: Bind contributor Role to ServiceAccount
      ansible.builtin.command: microk8s kubectl create rolebinding {{ sa_name }}-contributor-binding \
               --role={{ sa_name }}-contributor-role \
               --serviceaccount={{ kube_namespace }}:{{ sa_name }} \
               -n {{ kube_namespace }}
      when:
        - role == 'contributor'
        - rb_check_contributor.rc != 0
      failed_when: false
      changed_when: "'created' in stdout"

    - name: Create viewer Role YAML
      ansible.builtin.copy:
        dest: /tmp/{{ sa_name }}-viewer-role.yaml
        content: |
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            namespace: {{ kube_namespace }}
            name: {{ sa_name }}-viewer-role
          rules:
            - apiGroups: ["*"]
              resources: ["*"]
              verbs: ["get","list","watch"]
        mode: '0600'
      when:
        - role == 'viewer'
        - rb_check_viewer.rc != 0

    - name: Apply viewer Role
      ansible.builtin.command: microk8s kubectl apply -f /tmp/{{ sa_name }}-viewer-role.yaml
      when:
        - role == 'viewer'
        - rb_check_viewer.rc != 0
      changed_when: false

    - name: Bind viewer Role to ServiceAccount
      ansible.builtin.command: microk8s kubectl create rolebinding {{ sa_name }}-viewer-binding \
               --role={{ sa_name }}-viewer-role \
               --serviceaccount={{ kube_namespace }}:{{ sa_name }} \
               -n {{ kube_namespace }}
      when:
        - role == 'viewer'
        - rb_check_viewer.rc != 0
      failed_when: false
      changed_when: "'created' in stdout"

    # ---------------- Kubeconfig ----------------
    - name: Create kubeconfig file
      ansible.builtin.copy:
        dest: "./{{ kubeconfig_file }}"
        mode: '0600'
        content: |
          apiVersion: v1
          kind: Config
          clusters:
          - name: {{ cluster_name.stdout }}
            cluster:
              certificate-authority-data: {{ ca_b64.stdout }}
              server: {{ cluster_server.stdout }}
          contexts:
          - name: {{ sa_name }}-context
            context:
              cluster: {{ cluster_name.stdout }}
              user: {{ sa_name }}
              namespace: {{ kube_namespace }}
          current-context: {{ sa_name }}-context
          users:
          - name: {{ sa_name }}
            user:
              token: {{ token }}

    - name: Display kubeconfig path
      ansible.builtin.debug:
        msg: "âœ… Kubeconfig generated: {{ kubeconfig_file }}"

    # ---------------- Cleanup temp files ----------------
    - name: Cleanup temporary YAMLs
      ansible.builtin.file:
        path: "/tmp/{{ item }}"
        state: absent
      loop:
        - "{{ secret_name }}.yaml"
        - "{{ sa_name }}-contributor-role.yaml"
        - "{{ sa_name }}-viewer-role.yaml"
